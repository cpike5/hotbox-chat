@using HotBox.Client.State
@inject PresenceState PresenceState
@implements IDisposable

@if (PresenceState.IsLoading)
{
    <div class="skeleton skeleton-section-label"></div>
    @for (var i = 0; i < 4; i++)
    {
        <div class="skeleton-member">
            <div class="skeleton skeleton-avatar"></div>
            <div class="skeleton skeleton-member-name" style="width: @(_skeletonNameWidths[i % _skeletonNameWidths.Length])px;"></div>
        </div>
    }
    <div class="skeleton skeleton-section-label" style="margin-top: 16px;"></div>
    @for (var i = 0; i < 3; i++)
    {
        <div class="skeleton-member">
            <div class="skeleton skeleton-avatar"></div>
            <div class="skeleton skeleton-member-name" style="width: @(_skeletonNameWidths[(i + 2) % _skeletonNameWidths.Length])px;"></div>
        </div>
    }
}
else
{
    var isFirst = true;
    @foreach (var group in GroupedUsers)
    {
        <div class="members-section-label"
             role="heading"
             aria-level="3"
             style="@(!isFirst ? "margin-top: 16px;" : "")">
            @group.Key - @group.Value.Count
        </div>
        <div role="list">
            @foreach (var user in group.Value)
            {
                <div class="member-item @(user.Status == "Offline" ? "offline" : "")"
                     role="listitem"
                     aria-label="@GetMemberAriaLabel(user)">
                    <div class="member-avatar" style="background: @GetAvatarColor(user.DisplayName);" aria-hidden="true">
                        @GetInitials(user.DisplayName)
                        <span class="status-dot @GetStatusCssClass(user.Status)" aria-hidden="true"></span>
                    </div>
                    <span class="member-name">@user.DisplayName</span>
                    @if (user.IsAgent)
                    {
                        <span class="bot-badge" aria-hidden="true">BOT</span>
                    }
                </div>
            }
        </div>
        isFirst = false;
    }
}

@code {
    private static readonly int[] _skeletonNameWidths = { 72, 56, 88, 64, 48, 80, 60 };

    private static readonly string[] _statusOrder = { "Online", "Idle", "DoNotDisturb", "Offline" };

    private static readonly Dictionary<string, string> _statusLabels = new()
    {
        ["Online"] = "Online",
        ["Idle"] = "Idle",
        ["DoNotDisturb"] = "Do Not Disturb",
        ["Offline"] = "Offline"
    };

    private List<KeyValuePair<string, List<UserPresenceInfo>>> GroupedUsers { get; set; } = new();

    protected override void OnInitialized()
    {
        PresenceState.OnChange += OnPresenceChanged;
        BuildGroupedUsers();
    }

    private void OnPresenceChanged()
    {
        BuildGroupedUsers();
        InvokeAsync(StateHasChanged);
    }

    private void BuildGroupedUsers()
    {
        var allUsers = PresenceState.GetAllUsers();

        GroupedUsers = _statusOrder
            .Select(status => new KeyValuePair<string, List<UserPresenceInfo>>(
                _statusLabels.GetValueOrDefault(status, status),
                allUsers.Where(u => u.Status == status).OrderBy(u => u.DisplayName).ToList()))
            .Where(g => g.Value.Count > 0)
            .ToList();
    }

    private static string GetStatusCssClass(string status)
    {
        return status switch
        {
            "Online" => "online",
            "Idle" => "idle",
            "DoNotDisturb" => "dnd",
            "Offline" => "offline",
            _ => "offline"
        };
    }

    private static string GetStatusLabel(string status)
    {
        return _statusLabels.GetValueOrDefault(status, status);
    }

    private static string GetMemberAriaLabel(UserPresenceInfo user)
    {
        var label = user.DisplayName;
        if (user.IsAgent) label += ", Bot";
        label += ", " + GetStatusLabel(user.Status);
        return label;
    }

    private static string GetAvatarColor(string name)
    {
        int hash = 0;
        foreach (char c in name)
        {
            hash = c + ((hash << 5) - hash);
        }
        int hue = Math.Abs(hash) % 360;
        return $"hsl({hue}, 32%, 38%)";
    }

    private static string GetInitials(string displayName)
    {
        var parts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return displayName.Length >= 2
            ? displayName[..2].ToUpper()
            : displayName.ToUpper();
    }

    public void Dispose()
    {
        PresenceState.OnChange -= OnPresenceChanged;
    }
}
