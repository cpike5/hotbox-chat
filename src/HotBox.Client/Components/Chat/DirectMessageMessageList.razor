@using HotBox.Client.State
@using HotBox.Client.Models
@using System.Text.RegularExpressions
@inject DirectMessageState DirectMessageState
@inject AuthState AuthState
@inject IJSRuntime JS
@implements IDisposable

<div class="messages-area">
    <div class="messages-container">
        @if (DirectMessageState.ActiveConversationUserId is not null && !DirectMessageState.HasMoreMessages)
        {
            <div class="channel-welcome">
                <h2>@@ @DirectMessageState.ActiveConversationDisplayName</h2>
                <p>
                    This is the beginning of your conversation with @DirectMessageState.ActiveConversationDisplayName.
                </p>
            </div>
        }

        @if (DirectMessageState.IsLoadingMessages)
        {
            <div class="page-placeholder">
                <p>Loading messages...</p>
            </div>
        }
        else
        {
            @if (DirectMessageState.IsLoadingOlderMessages)
            {
                <div class="pagination-loader">
                    <span class="spinner"></span>
                </div>
            }

            string? lastAuthor = null;
            DateTime? lastTime = null;
            DateTime? lastDate = null;

            @foreach (var msg in DirectMessageState.Messages)
            {
                var messageDate = msg.CreatedAtUtc.ToLocalTime().Date;
                if (lastDate is null || messageDate != lastDate.Value)
                {
                    <div class="date-separator"><span>@FormatDateSeparator(msg.CreatedAtUtc)</span></div>
                }
                lastDate = messageDate;

                var isNewAuthor = msg.SenderDisplayName != lastAuthor
                    || (lastTime.HasValue && (msg.CreatedAtUtc - lastTime.Value).TotalMinutes > 5);

                if (isNewAuthor)
                {
                    <div id="msg-@msg.Id" class="message-group new-author @(ContainsMentionOfCurrentUser(msg.Content) ? "mentioned" : "")">
                        <div class="msg-avatar" style="background: @GetAvatarColor(msg.SenderDisplayName);">
                            @GetInitials(msg.SenderDisplayName)
                        </div>
                        <div class="msg-content">
                            <div class="msg-header">
                                <span class="msg-author" style="color: @GetAvatarColor(msg.SenderDisplayName);">
                                    @msg.SenderDisplayName
                                </span>
                                <span class="msg-timestamp">@FormatTime(msg.CreatedAtUtc)</span>
                            </div>
                            <div class="msg-body">@RenderMessageContent(msg.Content)</div>
                        </div>
                    </div>
                }
                else
                {
                    <div id="msg-@msg.Id" class="message-group @(ContainsMentionOfCurrentUser(msg.Content) ? "mentioned" : "")">
                        <div style="width: 34px; flex-shrink: 0;"></div>
                        <div class="msg-content">
                            <div class="msg-body">@RenderMessageContent(msg.Content)</div>
                        </div>
                    </div>
                }

                lastAuthor = msg.SenderDisplayName;
                lastTime = msg.CreatedAtUtc;
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public EventCallback OnScrollNearTop { get; set; }

    private bool _forceScroll;
    private bool _wasLoading;
    private DateTime _lastScrollCheck = DateTime.MinValue;

    protected override void OnInitialized()
    {
        DirectMessageState.OnChange += HandleStateChanged;
    }

    private void HandleStateChanged()
    {
        if (_wasLoading && !DirectMessageState.IsLoadingMessages)
        {
            _forceScroll = true;
        }
        _wasLoading = DirectMessageState.IsLoadingMessages;
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Skip auto-scroll during older messages loading to preserve scroll position
        if (!DirectMessageState.IsLoadingOlderMessages)
        {
            if (_forceScroll)
            {
                _forceScroll = false;
                await JS.InvokeVoidAsync("chatInterop.scrollToBottom", ".messages-area");
            }
            else if (DirectMessageState.Messages.Count > 0)
            {
                await JS.InvokeVoidAsync("chatInterop.scrollToBottomIfNearEnd", ".messages-area", 150);
            }
        }

        // Check if user has scrolled near top (debounced)
        if (!DirectMessageState.IsLoadingMessages && !DirectMessageState.IsLoadingOlderMessages)
        {
            var now = DateTime.UtcNow;
            if ((now - _lastScrollCheck).TotalMilliseconds >= 500)
            {
                _lastScrollCheck = now;
                var isNearTop = await JS.InvokeAsync<bool>("chatInterop.isNearTop", ".messages-area", 100);
                if (isNearTop)
                {
                    await OnScrollNearTop.InvokeAsync();
                }
            }
        }
    }

    private static string FormatTime(DateTime utc)
    {
        var local = utc.ToLocalTime();
        var now = DateTime.Now;
        var today = now.Date;
        var messageDate = local.Date;

        if (messageDate == today)
            return local.ToString("h:mm tt");
        if (messageDate == today.AddDays(-1))
            return "Yesterday " + local.ToString("h:mm tt");
        if (messageDate > today.AddDays(-7))
            return local.ToString("ddd h:mm tt");
        if (messageDate.Year == now.Year)
            return local.ToString("MMM d, h:mm tt");
        return local.ToString("MMM d, yyyy h:mm tt");
    }

    private static string FormatDateSeparator(DateTime utc)
    {
        var local = utc.ToLocalTime();
        var now = DateTime.Now;
        var today = now.Date;
        var messageDate = local.Date;

        if (messageDate == today)
            return "Today";
        if (messageDate == today.AddDays(-1))
            return "Yesterday";
        if (messageDate.Year == now.Year)
            return local.ToString("MMMM d");
        return local.ToString("MMMM d, yyyy");
    }

    private static string GetAvatarColor(string name)
    {
        int hash = 0;
        foreach (char c in name)
        {
            hash = c + ((hash << 5) - hash);
        }
        int hue = Math.Abs(hash) % 360;
        return $"hsl({hue}, 32%, 38%)";
    }

    private static string GetInitials(string displayName)
    {
        var parts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return displayName.Length >= 2
            ? displayName[..2].ToUpper()
            : displayName.ToUpper();
    }

    private static readonly Regex MentionRegex = new(@"@\[([^\]]+)\]\(([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})\)", RegexOptions.Compiled);

    private RenderFragment RenderMessageContent(string content) => builder =>
    {
        var lastIndex = 0;
        var seq = 0;

        foreach (Match match in MentionRegex.Matches(content))
        {
            if (match.Index > lastIndex)
            {
                builder.AddContent(seq++, content[lastIndex..match.Index]);
            }

            var displayName = match.Groups[1].Value;
            var userId = match.Groups[2].Value;
            var isSelf = AuthState.CurrentUser?.Id.ToString() == userId;

            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", isSelf ? "mention mention-self" : "mention");
            builder.AddContent(seq++, $"@{displayName}");
            builder.CloseElement();

            lastIndex = match.Index + match.Length;
        }

        if (lastIndex < content.Length)
        {
            builder.AddContent(seq++, content[lastIndex..]);
        }
    };

    private bool ContainsMentionOfCurrentUser(string content)
    {
        var currentUserId = AuthState.CurrentUser?.Id.ToString();
        if (currentUserId is null) return false;

        foreach (Match match in MentionRegex.Matches(content))
        {
            if (match.Groups[2].Value == currentUserId)
                return true;
        }
        return false;
    }

    public void Dispose()
    {
        DirectMessageState.OnChange -= HandleStateChanged;
    }
}
