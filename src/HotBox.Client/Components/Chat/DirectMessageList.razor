@using HotBox.Client.State
@using HotBox.Client.Models
@using HotBox.Client.Services
@inject DirectMessageState DirectMessageState
@inject UnreadStateService UnreadState
@inject ApiClient Api
@inject NavigationManager Navigation
@implements IDisposable

<div class="dm-conversation-list">
    @foreach (var conversation in DirectMessageState.Conversations)
    {
        var isActive = DirectMessageState.ActiveConversationUserId == conversation.UserId;
        <button class="channel-tab @(isActive ? "active" : "")"
                @onclick="() => SelectConversation(conversation)">
            <span class="tab-hash">@@</span>
            <span>@conversation.DisplayName</span>
            @{
                var dmUnread = UnreadState.GetDmUnreadCount(conversation.UserId);
            }
            @if (dmUnread > 0)
            {
                <span class="unread-badge">@dmUnread</span>
            }
        </button>
    }
</div>

<div style="position: relative; flex-shrink: 0;">
    <button class="new-dm-btn" @onclick="TogglePicker" @onclick:stopPropagation="true" aria-label="New direct message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
    @if (PickerOpen)
    {
        <NewDmPicker OnUserSelected="ClosePicker" />
    }
</div>

@if (PickerOpen)
{
    <div class="click-away-overlay active" @onclick="ClosePicker" style="z-index: 99;"></div>
}

@code {
    private bool _loaded;
    private bool PickerOpen { get; set; }

    protected override async Task OnInitializedAsync()
    {
        DirectMessageState.OnChange += StateHasChanged;
        UnreadState.OnChange += StateHasChanged;

        if (!_loaded && DirectMessageState.Conversations.Count == 0)
        {
            _loaded = true;
            var conversations = await Api.GetConversationsAsync();
            DirectMessageState.SetConversations(conversations);
        }
    }

    private void SelectConversation(ConversationSummaryResponse conversation)
    {
        DirectMessageState.SetActiveConversation(conversation.UserId, conversation.DisplayName);
        Navigation.NavigateTo($"/dm/{conversation.UserId}");
    }

    private void TogglePicker()
    {
        PickerOpen = !PickerOpen;
    }

    private void ClosePicker()
    {
        PickerOpen = false;
    }

    public void Dispose()
    {
        DirectMessageState.OnChange -= StateHasChanged;
        UnreadState.OnChange -= StateHasChanged;
    }
}
