@using HotBox.Client.State
@using HotBox.Client.Models
@using System.Text.RegularExpressions
@inject ChannelState ChannelState
@inject AuthState AuthState
@inject IJSRuntime JS
@implements IDisposable

<div class="messages-area">
    <div class="messages-container">
        @if (ChannelState.ActiveChannel is not null && !ChannelState.HasMoreMessages)
        {
            <div class="channel-welcome">
                <h2># @ChannelState.ActiveChannel.Name</h2>
                <p>
                    This is the start of the #@ChannelState.ActiveChannel.Name channel.@(ChannelState.ActiveChannel.Topic is not null ? $" {ChannelState.ActiveChannel.Topic}." : "")
                </p>
            </div>
        }

        <div class="messages-list">
        @if (ChannelState.IsLoadingMessages)
        {
            @for (var i = 0; i < _skeletonMessages.Length; i++)
            {
                var msg = _skeletonMessages[i];
                <div class="skeleton-message">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="skeleton-message-content">
                        <div class="skeleton-message-header">
                            <div class="skeleton skeleton-message-author" style="width: @(msg.AuthorWidth)px;"></div>
                            <div class="skeleton skeleton-message-time"></div>
                        </div>
                        <div class="skeleton skeleton-message-line" style="width: @(msg.Line1Width)%;"></div>
                        @if (msg.Line2Width > 0)
                        {
                            <div class="skeleton skeleton-message-line" style="width: @(msg.Line2Width)%;"></div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            @if (ChannelState.IsLoadingOlderMessages)
            {
                <div class="pagination-loader">
                    <span class="spinner"></span>
                </div>
            }

            string? lastAuthor = null;
            DateTime? lastTime = null;

            @foreach (var msg in ChannelState.Messages)
            {
                var isNewAuthor = msg.AuthorDisplayName != lastAuthor
                    || (lastTime.HasValue && (msg.CreatedAtUtc - lastTime.Value).TotalMinutes > 5);

                if (isNewAuthor)
                {
                    <div id="msg-@msg.Id" class="message-group new-author @(ContainsMentionOfCurrentUser(msg.Content) ? "mentioned" : "")">
                        <div class="msg-avatar" style="background: @GetAvatarColor(msg.AuthorDisplayName);">
                            @GetInitials(msg.AuthorDisplayName)
                        </div>
                        <div class="msg-content">
                            <div class="msg-header">
                                <span class="msg-author"
                                      style="color: @GetAvatarColor(msg.AuthorDisplayName);"
                                      @onclick="(e) => ToggleAuthorProfile(msg.AuthorId, e)"
                                      @onclick:stopPropagation="true">
                                    @msg.AuthorDisplayName
                                </span>
                                @if (msg.IsAgent)
                                {
                                    <span class="visually-hidden">Bot</span>
                                    <span class="bot-badge" aria-hidden="true">BOT</span>
                                }
                                <span class="msg-timestamp">@FormatTime(msg.CreatedAtUtc)</span>
                            </div>
                            <div class="msg-body">@RenderMessageContent(msg.Content)</div>
                        </div>
                    </div>
                }
                else
                {
                    <div id="msg-@msg.Id" class="message-group @(ContainsMentionOfCurrentUser(msg.Content) ? "mentioned" : "")">
                        <div style="width: 34px; flex-shrink: 0;"></div>
                        <div class="msg-content">
                            <div class="msg-body">@RenderMessageContent(msg.Content)</div>
                        </div>
                    </div>
                }

                lastAuthor = msg.AuthorDisplayName;
                lastTime = msg.CreatedAtUtc;
            }
        }
        </div>
    </div>
</div>

@if (_selectedAuthorId.HasValue)
{
    <UserProfilePopover UserId="_selectedAuthorId.Value" AnchorX="_anchorX" AnchorY="_anchorY" OnClose="ClosePopover" />
}

@code {
    [Parameter]
    public EventCallback OnScrollNearTop { get; set; }

    private record SkeletonMessageDef(int AuthorWidth, int Line1Width, int Line2Width);

    private static readonly SkeletonMessageDef[] _skeletonMessages =
    {
        new(72, 80, 45),
        new(56, 60, 0),
        new(88, 90, 70),
        new(64, 50, 30),
        new(48, 75, 0),
        new(80, 65, 40)
    };

    private bool _forceScroll;
    private bool _wasLoading;
    private DateTime _lastScrollCheck = DateTime.MinValue;
    private Guid? _selectedAuthorId;
    private double _anchorX;
    private double _anchorY;

    protected override void OnInitialized()
    {
        ChannelState.OnChange += HandleStateChanged;
    }

    private void HandleStateChanged()
    {
        // When loading transitions from true → false, messages just arrived — force scroll to bottom
        if (_wasLoading && !ChannelState.IsLoadingMessages)
        {
            _forceScroll = true;
        }
        _wasLoading = ChannelState.IsLoadingMessages;
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Skip auto-scroll during older messages loading to preserve scroll position
        if (!ChannelState.IsLoadingOlderMessages)
        {
            if (_forceScroll)
            {
                _forceScroll = false;
                await JS.InvokeVoidAsync("chatInterop.scrollToBottom", ".messages-area");
            }
            else if (ChannelState.Messages.Count > 0)
            {
                await JS.InvokeVoidAsync("chatInterop.scrollToBottomIfNearEnd", ".messages-area", 150);
            }
        }

        // Check if user has scrolled near top (debounced)
        if (!ChannelState.IsLoadingMessages && !ChannelState.IsLoadingOlderMessages)
        {
            var now = DateTime.UtcNow;
            if ((now - _lastScrollCheck).TotalMilliseconds >= 500)
            {
                _lastScrollCheck = now;
                var isNearTop = await JS.InvokeAsync<bool>("chatInterop.isNearTop", ".messages-area", 100);
                if (isNearTop)
                {
                    await OnScrollNearTop.InvokeAsync();
                }
            }
        }
    }

    private static string FormatTime(DateTime utc)
    {
        var local = utc.ToLocalTime();
        return local.ToString("h:mm tt");
    }

    private static string GetAvatarColor(string name)
    {
        int hash = 0;
        foreach (char c in name)
        {
            hash = c + ((hash << 5) - hash);
        }
        int hue = Math.Abs(hash) % 360;
        return $"hsl({hue}, 32%, 38%)";
    }

    private static string GetInitials(string displayName)
    {
        var parts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return displayName.Length >= 2
            ? displayName[..2].ToUpper()
            : displayName.ToUpper();
    }

    private void ToggleAuthorProfile(Guid authorId, MouseEventArgs e)
    {
        if (_selectedAuthorId == authorId)
        {
            _selectedAuthorId = null;
        }
        else
        {
            _anchorX = e.ClientX;
            _anchorY = e.ClientY;
            _selectedAuthorId = authorId;
        }
    }

    private void ClosePopover()
    {
        _selectedAuthorId = null;
    }

    private static readonly Regex MentionRegex = new(@"@\[([^\]]+)\]\(([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})\)", RegexOptions.Compiled);

    private RenderFragment RenderMessageContent(string content) => builder =>
    {
        var lastIndex = 0;
        var seq = 0;

        foreach (Match match in MentionRegex.Matches(content))
        {
            if (match.Index > lastIndex)
            {
                builder.AddContent(seq++, content[lastIndex..match.Index]);
            }

            var displayName = match.Groups[1].Value;
            var userId = match.Groups[2].Value;
            var isSelf = AuthState.CurrentUser?.Id.ToString() == userId;

            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", isSelf ? "mention mention-self" : "mention");
            builder.AddContent(seq++, $"@{displayName}");
            builder.CloseElement();

            lastIndex = match.Index + match.Length;
        }

        if (lastIndex < content.Length)
        {
            builder.AddContent(seq++, content[lastIndex..]);
        }
    };

    private bool ContainsMentionOfCurrentUser(string content)
    {
        var currentUserId = AuthState.CurrentUser?.Id.ToString();
        if (currentUserId is null) return false;

        foreach (Match match in MentionRegex.Matches(content))
        {
            if (match.Groups[2].Value == currentUserId)
                return true;
        }
        return false;
    }

    public void Dispose()
    {
        ChannelState.OnChange -= HandleStateChanged;
    }
}
