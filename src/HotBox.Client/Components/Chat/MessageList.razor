@using HotBox.Client.State
@using HotBox.Client.Models
@inject ChannelState ChannelState
@inject IJSRuntime JS
@implements IDisposable

<div class="messages-area">
    <div class="messages-container">
        @if (ChannelState.ActiveChannel is not null)
        {
            <div class="channel-welcome">
                <h2># @ChannelState.ActiveChannel.Name</h2>
                <p>
                    This is the start of the #@ChannelState.ActiveChannel.Name channel.@(ChannelState.ActiveChannel.Topic is not null ? $" {ChannelState.ActiveChannel.Topic}." : "")
                </p>
            </div>
        }

        @if (ChannelState.IsLoadingMessages)
        {
            @for (var i = 0; i < _skeletonMessages.Length; i++)
            {
                var msg = _skeletonMessages[i];
                <div class="skeleton-message">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="skeleton-message-content">
                        <div class="skeleton-message-header">
                            <div class="skeleton skeleton-message-author" style="width: @(msg.AuthorWidth)px;"></div>
                            <div class="skeleton skeleton-message-time"></div>
                        </div>
                        <div class="skeleton skeleton-message-line" style="width: @(msg.Line1Width)%;"></div>
                        @if (msg.Line2Width > 0)
                        {
                            <div class="skeleton skeleton-message-line" style="width: @(msg.Line2Width)%;"></div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            @if (ChannelState.IsLoadingOlderMessages)
            {
                <div class="pagination-loader">
                    <span class="spinner"></span>
                </div>
            }

            string? lastAuthor = null;
            DateTime? lastTime = null;

            @foreach (var msg in ChannelState.Messages)
            {
                var isNewAuthor = msg.AuthorDisplayName != lastAuthor
                    || (lastTime.HasValue && (msg.CreatedAtUtc - lastTime.Value).TotalMinutes > 5);

                if (isNewAuthor)
                {
                    <div class="message-group new-author">
                        <div class="msg-avatar" style="background: @GetAvatarColor(msg.AuthorDisplayName);">
                            @GetInitials(msg.AuthorDisplayName)
                        </div>
                        <div class="msg-content">
                            <div class="msg-header">
                                <span class="msg-author"
                                      style="color: @GetAvatarColor(msg.AuthorDisplayName); cursor: pointer;"
                                      @onclick="() => ToggleAuthorProfile(msg.AuthorId)"
                                      @onclick:stopPropagation="true">
                                    @msg.AuthorDisplayName
                                </span>
                                @if (msg.IsAgent)
                                {
                                    <span class="visually-hidden">Bot</span>
                                    <span class="bot-badge" aria-hidden="true">BOT</span>
                                }
                                <span class="msg-timestamp">@FormatTime(msg.CreatedAtUtc)</span>
                            </div>
                            <div class="msg-body">@msg.Content</div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="message-group">
                        <div style="width: 34px; flex-shrink: 0;"></div>
                        <div class="msg-content">
                            <div class="msg-body">@msg.Content</div>
                        </div>
                    </div>
                }

                lastAuthor = msg.AuthorDisplayName;
                lastTime = msg.CreatedAtUtc;
            }
        }
    </div>
</div>

@if (_selectedAuthorId.HasValue)
{
    <UserProfilePopover UserId="_selectedAuthorId.Value" OnClose="ClosePopover" />
}

@code {
    private record SkeletonMessageDef(int AuthorWidth, int Line1Width, int Line2Width);

    private static readonly SkeletonMessageDef[] _skeletonMessages =
    {
        new(72, 80, 45),
        new(56, 60, 0),
        new(88, 90, 70),
        new(64, 50, 30),
        new(48, 75, 0),
        new(80, 65, 40)
    };

    private bool _forceScroll;
    private bool _wasLoading;
    private Guid? _selectedAuthorId;

    protected override void OnInitialized()
    {
        ChannelState.OnChange += HandleStateChanged;
    }

    private void HandleStateChanged()
    {
        // When loading transitions from true → false, messages just arrived — force scroll to bottom
        if (_wasLoading && !ChannelState.IsLoadingMessages)
        {
            _forceScroll = true;
        }
        _wasLoading = ChannelState.IsLoadingMessages;
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_forceScroll)
        {
            _forceScroll = false;
            await JS.InvokeVoidAsync("chatInterop.scrollToBottom", ".messages-area");
        }
        else if (ChannelState.Messages.Count > 0)
        {
            await JS.InvokeVoidAsync("chatInterop.scrollToBottomIfNearEnd", ".messages-area", 150);
        }
    }

    private static string FormatTime(DateTime utc)
    {
        var local = utc.ToLocalTime();
        return local.ToString("h:mm tt");
    }

    private static string GetAvatarColor(string name)
    {
        int hash = 0;
        foreach (char c in name)
        {
            hash = c + ((hash << 5) - hash);
        }
        int hue = Math.Abs(hash) % 360;
        return $"hsl({hue}, 32%, 38%)";
    }

    private static string GetInitials(string displayName)
    {
        var parts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return displayName.Length >= 2
            ? displayName[..2].ToUpper()
            : displayName.ToUpper();
    }

    private void ToggleAuthorProfile(Guid authorId)
    {
        if (_selectedAuthorId == authorId)
            _selectedAuthorId = null;
        else
            _selectedAuthorId = authorId;
    }

    private void ClosePopover()
    {
        _selectedAuthorId = null;
    }

    public void Dispose()
    {
        ChannelState.OnChange -= HandleStateChanged;
    }
}
