@inherits LayoutComponentBase
@using HotBox.Client.Models
@using HotBox.Client.Services
@using HotBox.Client.State
@using HotBox.Core.Enums
@inject ChannelState ChannelState
@inject AuthState AuthState
@inject PresenceState PresenceState
@inject VoiceState VoiceState
@inject ChatHubService ChatHubService
@inject NotificationState NotificationState
@inject VoiceConnectionManager VoiceConnectionManager
@inject NavigationManager Navigation
@inject DirectMessageState DirectMessageState
@inject SearchState SearchState
@inject ApiClient Api
@inject UnreadStateService UnreadState
@inject ILogger<MainLayout> Logger
@implements IDisposable

<div class="app">

    <!-- ============ Connection Status Banner ============ -->
    <ConnectionStatus />

    <!-- ============ Top Bar ============ -->
    <header class="topbar">
        <div class="topbar-brand">HotBox</div>

        <!-- Section switcher -->
        <div class="section-switcher">
            <button class="section-btn @(ActiveSection == "channels" ? "active" : "")"
                    @onclick='() => SwitchSection("channels")'>Channels</button>
            <button class="section-btn @(ActiveSection == "dms" ? "active" : "")"
                    @onclick='() => SwitchSection("dms")'>DMs</button>
        </div>

        <div class="topbar-divider"></div>

        <!-- Channel / DM tabs -->
        <div class="channel-tabs @(ActiveSection == "dms" ? "dm-mode" : "")">
            @if (ActiveSection == "channels")
            {
                <ChannelList />
            }
            else
            {
                <DirectMessageList />
            }
        </div>

        <div class="topbar-divider"></div>

        <!-- Right side controls -->
        <div class="topbar-right">
            <!-- Members toggle -->
            <button class="members-trigger @(MembersVisible ? "active" : "")"
                    @onclick="ToggleMembers"
                    aria-label="Toggle members panel">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </button>

            <!-- Voice channels dropdown -->
            <div style="position: relative;">
                <button class="voice-dropdown-trigger"
                        @onclick="ToggleVoiceDropdown"
                        @onclick:stopPropagation="true"
                        aria-label="Voice channels">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                    <span>Voice</span>
                    <span class="voice-count">@VoiceState.ConnectedPeers.Count</span>
                </button>
                <div class="voice-dropdown @(VoiceDropdownOpen ? "open" : "")">
                    <div class="voice-dropdown-header">Voice Channels</div>
                    @foreach (var channel in VoiceChannels)
                    {
                        var isConnected = VoiceState.CurrentVoiceChannelId == channel.Id;
                        <div class="voice-channel-item @(isConnected ? "connected" : "")"
                             @onclick="() => JoinVoiceChannel(channel)">
                            <svg class="voice-channel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                            <span class="voice-channel-name">@channel.Name</span>
                        </div>
                    }
                    @if (!VoiceChannels.Any())
                    {
                        <div class="voice-channel-item" style="opacity: 0.5; cursor: default;">
                            <span class="voice-channel-name">No voice channels</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Notifications -->
            <button class="topbar-icon-btn" aria-label="Notifications" @onclick="NavigateToNotifications"
                    style="position: relative;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                @if (NotificationState.UnreadCount > 0)
                {
                    <span class="notification-badge">@(NotificationState.UnreadCount > 99 ? "99+" : NotificationState.UnreadCount.ToString())</span>
                }
            </button>

            <!-- Search -->
            <button class="topbar-icon-btn" aria-label="Search" @onclick="OpenSearch">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>

            <!-- Settings (admin only) -->
            @if (AuthState.CurrentUser?.Role == "Admin")
            {
                <button class="topbar-icon-btn" aria-label="Admin Settings" @onclick="NavigateToAdmin">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            }

            <!-- Edit Profile -->
            <button class="topbar-icon-btn" aria-label="Edit Profile" title="Edit Profile" @onclick="OpenEditProfile">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>

            <!-- User avatar -->
            <div class="topbar-user" aria-label="User profile">
                U
                <span class="status-dot online"></span>
            </div>
        </div>
    </header>

    <!-- ============ Channel Info Sub-bar ============ -->
    <div class="channel-info-bar">
        <ChannelHeader />
    </div>

    <!-- ============ Main Content ============ -->
    <main class="main-content">
        @Body
    </main>

    <!-- ============ Members Overlay (slide-in from right) ============ -->
    <aside class="members-overlay @(MembersVisible ? "open" : "")">
        <MembersPanel />
    </aside>

    <!-- ============ Voice Bar (bottom, shown when connected) ============ -->
    @if (VoiceState.ConnectionStatus != VoiceConnectionStatus.Disconnected)
    {
        <div class="voice-bar">
            <div class="voice-bar-status">
                <div class="voice-bar-pulse"></div>
                <span class="voice-bar-label">
                    @(VoiceState.ConnectionStatus == VoiceConnectionStatus.Connecting ? "Connecting..." : "Connected")
                </span>
            </div>
            <span class="voice-bar-channel">@VoiceState.CurrentVoiceChannelName</span>
            <div class="voice-bar-users">
                @foreach (var peer in VoiceState.ConnectedPeers)
                {
                    <span class="voice-bar-user-chip">@peer.DisplayName</span>
                }
            </div>
            <div class="voice-bar-spacer"></div>
            <div class="voice-bar-controls">
                <button class="voice-bar-btn @(VoiceState.IsMuted ? "active" : "")"
                        @onclick="ToggleMute"
                        aria-label="Toggle mute">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>
                <button class="voice-bar-btn @(VoiceState.IsDeafened ? "active" : "")"
                        @onclick="ToggleDeafen"
                        aria-label="Toggle deafen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 18v-6a9 9 0 0 1 18 0v6"></path>
                        <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path>
                    </svg>
                </button>
                <button class="voice-bar-btn disconnect"
                        @onclick="LeaveVoiceChannel"
                        aria-label="Disconnect from voice">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"></path>
                        <line x1="23" y1="1" x2="1" y2="23"></line>
                    </svg>
                </button>
            </div>
        </div>
    }

    <!-- ============ Search Overlay ============ -->
    <SearchOverlay />

    <!-- ============ Toast Notifications ============ -->
    <ToastContainer />
</div>

@* Click-away overlay for closing dropdowns *@
@if (VoiceDropdownOpen)
{
    <div class="click-away-overlay active" @onclick="CloseVoiceDropdown"></div>
}

@if (_showEditProfile)
{
    <EditProfileModal OnClose="CloseEditProfile" OnSaved="HandleProfileSaved" />
}

@code {
    private string ActiveSection { get; set; } = "channels";
    private bool MembersVisible { get; set; }
    private bool VoiceDropdownOpen { get; set; }
    private System.Threading.Timer? _heartbeatTimer;

    private IEnumerable<ChannelResponse> VoiceChannels =>
        ChannelState.Channels.Where(c => c.Type == ChannelType.Voice);

    protected override async Task OnInitializedAsync()
    {
        // Route guard: redirect unauthenticated users to login
        if (!AuthState.IsAuthenticated)
        {
            AuthState.SetReturnUrl(Navigation.Uri);
            Navigation.NavigateTo("/login", replace: true);
            return;
        }

        ChannelState.OnChange += StateHasChanged;
        VoiceState.OnChange += StateHasChanged;

        // Subscribe to presence events from ChatHubService
        ChatHubService.OnUserStatusChanged += HandleUserStatusChanged;
        ChatHubService.OnOnlineUsers += HandleOnlineUsers;
        ChatHubService.OnConnectionChanged += HandleConnectionChanged;
        NotificationState.OnChange += StateHasChanged;

        // Load channels into state so the sidebar and voice dropdown are populated immediately
        var channels = await Api.GetChannelsAsync();
        ChannelState.SetChannels(channels);

        // Start the SignalR hub connection so we receive presence and real-time events
        if (AuthState.AccessToken is not null)
        {
            await ChatHubService.StartAsync(AuthState.AccessToken);

            // Initialize the voice connection manager with the current access token
            await VoiceConnectionManager.InitializeAsync(AuthState.AccessToken);

            // Load initial unread counts
            await UnreadState.InitializeAsync();

            // Load initial notification unread count
            await NotificationState.InitializeAsync();
        }

        // Heartbeat timer is started/stopped via HandleConnectionChanged
        // based on actual connection state rather than running unconditionally.
    }

    private void HandleUserStatusChanged(Guid userId, string displayName, string status, bool isAgent)
    {
        PresenceState.UpdateUserStatus(userId, displayName, status, isAgent);
    }

    private void HandleOnlineUsers(List<HotBox.Client.Models.OnlineUserInfoModel> users)
    {
        PresenceState.SetOnlineUsers(users);
    }

    private async void HandleConnectionChanged(bool connected)
    {
        if (connected)
        {
            // Seed all registered users as Offline so they appear in the members panel
            // even if they have never connected via SignalR. The subsequent OnOnlineUsers
            // event will overlay actual online statuses on top.
            try
            {
                var allUsers = await Api.GetAllUsersAsync();
                if (allUsers is not null)
                {
                    PresenceState.SeedAllUsers(allUsers);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to seed all users for presence state");
            }

            // Start heartbeat timer when connected (fires every 60 seconds)
            _heartbeatTimer?.Dispose();
            _heartbeatTimer = new System.Threading.Timer(
                async _ => await SendHeartbeatAsync(),
                null,
                TimeSpan.FromSeconds(60),
                TimeSpan.FromSeconds(60));
        }
        else
        {
            // Stop heartbeat timer and clear presence data when disconnected
            _heartbeatTimer?.Dispose();
            _heartbeatTimer = null;
            PresenceState.Clear();
        }
    }

    private async Task SendHeartbeatAsync()
    {
        if (_heartbeatTimer is null)
            return;

        try
        {
            if (ChatHubService.IsConnected)
            {
                await ChatHubService.SendHeartbeatAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to send heartbeat");
        }
    }

    private void NavigateToNotifications()
    {
        Navigation.NavigateTo("/notifications");
    }

    private void OpenSearch()
    {
        SearchState.Open();
    }

    private void NavigateToAdmin()
    {
        Navigation.NavigateTo("/admin");
    }

    private void SwitchSection(string section)
    {
        if (ActiveSection == section)
            return;

        ActiveSection = section;

        if (section == "dms")
        {
            // Clear active channel when switching to DMs
            ChannelState.ClearActiveChannel();

            if (DirectMessageState.ActiveConversationUserId.HasValue)
                Navigation.NavigateTo($"/dm/{DirectMessageState.ActiveConversationUserId.Value}");
            else if (DirectMessageState.Conversations.Count > 0)
            {
                var mostRecent = DirectMessageState.Conversations[0];
                DirectMessageState.SetActiveConversation(mostRecent.UserId, mostRecent.DisplayName);
                Navigation.NavigateTo($"/dm/{mostRecent.UserId}");
            }
            else
                Navigation.NavigateTo("/dms");
        }
        else
        {
            // Clear active DM conversation when switching to channels
            DirectMessageState.ClearActiveConversation();

            if (ChannelState.ActiveChannel is not null)
                Navigation.NavigateTo($"/channels/{ChannelState.ActiveChannel.Id}");
            else
                Navigation.NavigateTo("/");
        }
    }

    private void ToggleMembers()
    {
        MembersVisible = !MembersVisible;
    }

    private void ToggleVoiceDropdown()
    {
        VoiceDropdownOpen = !VoiceDropdownOpen;
    }

    private void CloseVoiceDropdown()
    {
        VoiceDropdownOpen = false;
    }

    private async Task JoinVoiceChannel(ChannelResponse channel)
    {
        // If already connected to this channel, do nothing
        if (VoiceState.CurrentVoiceChannelId == channel.Id)
        {
            CloseVoiceDropdown();
            return;
        }

        // If connected to a different channel, leave it first
        if (VoiceState.ConnectionStatus != VoiceConnectionStatus.Disconnected
            && VoiceState.CurrentVoiceChannelId.HasValue)
        {
            await LeaveVoiceChannel();
        }

        CloseVoiceDropdown();

        await VoiceConnectionManager.JoinChannelAsync(channel.Id, channel.Name);
    }

    private async Task LeaveVoiceChannel()
    {
        await VoiceConnectionManager.LeaveChannelAsync();
    }

    private async Task ToggleMute()
    {
        await VoiceConnectionManager.ToggleMuteAsync();
    }

    private async Task ToggleDeafen()
    {
        await VoiceConnectionManager.ToggleDeafenAsync();
    }

    private bool _showEditProfile;

    private void OpenEditProfile()
    {
        _showEditProfile = true;
    }

    private void CloseEditProfile()
    {
        _showEditProfile = false;
    }

    private void HandleProfileSaved()
    {
        _showEditProfile = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        ChannelState.OnChange -= StateHasChanged;
        VoiceState.OnChange -= StateHasChanged;
        ChatHubService.OnUserStatusChanged -= HandleUserStatusChanged;
        ChatHubService.OnOnlineUsers -= HandleOnlineUsers;
        ChatHubService.OnConnectionChanged -= HandleConnectionChanged;
        NotificationState.OnChange -= StateHasChanged;
        _heartbeatTimer?.Dispose();
    }
}
