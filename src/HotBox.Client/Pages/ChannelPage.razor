@page "/channels/{Id:guid}"
@using HotBox.Client.Models
@using HotBox.Client.State
@using HotBox.Client.Services
@inject ChannelState ChannelState
@inject ApiClient Api
@inject ChatHubService ChatHub
@implements IDisposable

<PageTitle>HotBox - @(ChannelState.ActiveChannel?.Name ?? "Channel")</PageTitle>

<MessageList />
<MessageInput />

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Guid _currentChannelId;

    protected override void OnInitialized()
    {
        // Subscribe to real-time channel events
        ChatHub.OnMessageReceived += HandleMessageReceived;
        ChatHub.OnUserTyping += HandleUserTyping;
        ChatHub.OnUserStoppedTyping += HandleUserStoppedTyping;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Avoid reloading if navigating to the same channel
        if (_currentChannelId == Id)
            return;

        _currentChannelId = Id;

        // Set active channel from the already-loaded channel list
        var channel = ChannelState.Channels.FirstOrDefault(c => c.Id == Id);
        if (channel is not null)
        {
            ChannelState.SetActiveChannel(channel);
        }
        else
        {
            // Channel not in local state; fetch it directly
            var fetched = await Api.GetChannelAsync(Id);
            if (fetched is not null)
            {
                ChannelState.SetActiveChannel(fetched);
            }
        }

        // Load messages for this channel
        ChannelState.SetLoadingMessages(true);
        try
        {
            var messages = await Api.GetMessagesAsync(Id);
            ChannelState.SetMessages(messages);
        }
        finally
        {
            ChannelState.SetLoadingMessages(false);
        }

        // Join the SignalR channel group if connected
        if (ChatHub.IsConnected)
        {
            await ChatHub.JoinChannelAsync(Id);
        }
    }

    private void HandleMessageReceived(MessageResponse message)
    {
        if (message.ChannelId == _currentChannelId)
        {
            // Clear typing indicator for the author who just sent a message
            ChannelState.RemoveTypingUser(message.AuthorId);
            ChannelState.AddMessage(message);
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleUserTyping(Guid channelId, Guid userId, string displayName)
    {
        if (channelId == _currentChannelId)
        {
            ChannelState.AddTypingUser(userId, displayName);
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleUserStoppedTyping(Guid channelId, Guid userId)
    {
        if (channelId == _currentChannelId)
        {
            ChannelState.RemoveTypingUser(userId);
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        // Unsubscribe from real-time events
        ChatHub.OnMessageReceived -= HandleMessageReceived;
        ChatHub.OnUserTyping -= HandleUserTyping;
        ChatHub.OnUserStoppedTyping -= HandleUserStoppedTyping;

        // Leave the SignalR channel group when navigating away
        if (ChatHub.IsConnected && _currentChannelId != Guid.Empty)
        {
            _ = ChatHub.LeaveChannelAsync(_currentChannelId);
        }
    }
}
