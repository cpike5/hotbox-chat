@page "/"
@using HotBox.Client.State
@using HotBox.Core.Enums
@inject NavigationManager Navigation
@inject ChannelState ChannelState
@implements IDisposable

<PageTitle>HotBox</PageTitle>

@if (!_redirected)
{
    <div class="page-placeholder">
        <h2>Welcome to HotBox</h2>
        <p>Select a channel or direct message to get started.</p>
    </div>
}

@code {
    private bool _redirected;

    protected override void OnInitialized()
    {
        if (TryRedirectToFirstChannel())
            return;

        // Channels may not be loaded yet â€” subscribe to state changes
        ChannelState.OnChange += OnChannelsChanged;
    }

    private void OnChannelsChanged()
    {
        TryRedirectToFirstChannel();
    }

    private bool TryRedirectToFirstChannel()
    {
        var first = ChannelState.Channels
            .Where(c => c.Type == ChannelType.Text)
            .OrderBy(c => c.SortOrder)
            .FirstOrDefault();

        if (first is null)
            return false;

        _redirected = true;
        ChannelState.OnChange -= OnChannelsChanged;
        Navigation.NavigateTo($"/channels/{first.Id}", replace: true);
        return true;
    }

    public void Dispose()
    {
        ChannelState.OnChange -= OnChannelsChanged;
    }
}
